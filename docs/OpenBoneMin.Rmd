---
title: A multiscale systems model of bone health and mineral homeostasis
author: "Metrum Research Group, LLC"
date: ""
output: 
  github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(comment = '.', warning = FALSE, message = FALSE)
knitr::opts_chunk$set(fig.path = "img/OpenBoneMin-")
```

# Background and Motivation

The model was originally developed to describe the bone marker changes associated with denosumab administration from a then ongoing clinical trial. Associated changes in serum calcium and PTH were also considered of interest at the time and so justified the development of a 'systems' model that included bone remodeling and bone mineral (calcium and phosphate) homeostatic mechanisms. Other therapeutics (e.g., teriparatide) and disease states (kidney failure, parathyroid-related abnormalities) were also considered at the time to further inform the parameterization and estimation of the model (Peterson and Riggs, Bone 2010).

# Install from GitHub

```{r,eval = FALSE}
remotes::install_github("metrumresearchgroup/OpenBoneMin")
```

```{r}
library(OpenBoneMin)
library(tidyverse)
```


# Load the Bone / Mineral model
```{r}
mod <- BoneMin()
```


# An example simulation of teriparatide administration

- We'll give either 20 or 40 micrograms SQ daily for 
```{r}
out <- sim_teri(dose = c(20,40), dur = 9)

out
```

PTH profiles for the 20 and 40 microgram doses

```{r}
plot(out, PTHpm ~ time|ID, scales = "same")
```


Calcium profiles for the 20 and 40 microgram doses

```{r}
plot(out, CaC~time)
```


# Denosumab administration
```{r}
out <- sim_denos(dose = c(30,60,210))

plot(out, DENCP ~.,  scales = list(y=list(log = TRUE)), 
     ylim = c(1E-4, 10E5))
```
```{r}
plot(out, BMDlsDENchange ~ .)
```

# Riggs and Peterson 2012


Predicting Nonlinear Changes in Bone Mineral Density Over Time Using a 
Multiscale Systems Pharmacology Model


## Generate the dosing regimens


__60 mg every 6 months x 8__

```{r}
month <- 24*28

e1 <- ev(amt = 60, ii = 6*month, addl = 7)
```

__14 mg every 6 months x4, then 60 mg every 6 months x4__
```{r}
e2 <- 
  mutate(e1, amt = 14, addl = 3) %then% 
  mutate(e1, addl = 3)
e2
```

__30 mg every 3 months for 8 doses and changed to 60 mg Q6M starting 
on month 36__

```{r}
e3a <- ev(amt = 30, ii = 3*month, addl = 7)
e3b <- mutate(e1, addl = 1)
e3 <- seq(e3a, wait = 12*month, e3b)
e3
```


__210 mg every 6 months x4 then DC__
```{r}
e4 <- mutate(e1, amt = 210, addl = 3)
e4
```


Create one single data set from which to simulate
```{r}
data <- as_data_set(e1,e2,e3,e4)

data
```

```{r}
out <- mrgsim_df(mod, data = data, end = 48*month, delta = 0.5)
```


```{r}
ggplot(out) + 
  geom_line(aes(x = time/month, y = OCchange, col = factor(ID)), lwd = 1) + 
  facet_grid(~ID) + geom_hline(yintercept = 100, lty = 2) +
  scale_y_continuous(trans = "log10", breaks = c(10,30,100,300), limits = c(5,300)) + 
  theme_bw() + theme(legend.position = "top") +
   geom_vline(xintercept = c(24,36), lty = 3)
```


```{r}
ggplot(out) + 
  geom_line(aes(x = time/(month), y = OBchange, col = factor(ID)), lwd = 1) + 
  facet_grid(~ID) + geom_hline(yintercept = 100, lty = 2) +
  scale_y_continuous(trans = "log10", breaks = c(10,30,100,300), limits = c(5,300)) +
  theme_bw() + theme(legend.position = "top") + 
  geom_vline(xintercept = c(24,36), lty = 3)
```

```{r}
ggplot(out) + 
  geom_line(aes(x = time/(month), y = BMDlsDENchange, col = factor(ID)), lwd = 1) + 
  facet_grid(~ID) + 
  theme_bw() + theme(legend.position = "top") + 
  geom_vline(xintercept = c(24,36), lty = 3)
```